import{z as je,j as e,l as ye,D as Te,r as k,P as Ie,B as ge,G as p,k as $,A as we,M as xe,ad as fe,S as me,L as be,ae as Se}from"./index-cq5hzz0D.js";import{F as Le,h as Be,e as ve}from"./index.esm-CPFEyeFY.js";import{c as Ae,h as N,i as c,e as t,j as De,g as Me,k as Ve,B as Y,P as Fe,F as Re,l as R,m as he}from"./MUIThemeProvider-xnG46D3_.js";import{u as Ce,L as ke,j as H}from"./DateTimePicker-CaOj6elI.js";import{A as Oe,a as Ee}from"./ApiConstants-Dtw084aJ.js";import{d as Pe}from"./helperFuntions-lPcVCZQ3.js";import{S as Ne,T as i,I as He,L as ue}from"./IconTrash-DB5oEuoR.js";import{T as _}from"./Title-bxlz7w_Z.js";/**
 * @license @tabler/icons-react v3.21.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var $e=je("outline","edit","IconEdit",[["path",{d:"M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1",key:"svg-0"}],["path",{d:"M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z",key:"svg-1"}],["path",{d:"M16 5l3 3",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.21.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var pe=je("outline","file-download","IconFileDownload",[["path",{d:"M14 3v4a1 1 0 0 0 1 1h4",key:"svg-0"}],["path",{d:"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z",key:"svg-1"}],["path",{d:"M12 17v-6",key:"svg-2"}],["path",{d:"M9.5 14.5l2.5 2.5l2.5 -2.5",key:"svg-3"}]]);const Ye=Ae(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle"),_e=({updates:r})=>{const s=Ee.EDIT_MERCHANT_INVOICE();return Oe.PUT(s,r)},Ue=()=>{const r=ye();return Ce({mutationFn:({updates:s})=>_e({updates:s}),onSuccess:s=>{var x;Te.show({title:"Invoice Update",message:((x=s==null?void 0:s.data)==null?void 0:x.message)??"Invoice updated successfully",color:"green",autoClose:2e3,position:"top-center"}),r.invalidateQueries({queryKey:["All_Invoices-Grid-data"]})},onError:s=>{Pe(s)}})};function ze(){var E,D,M,V,C,F,P,I,g,w,f,b,S;const{values:r,setFieldValue:s}=ve(),x=a=>{var o,l,d,j;s("invoiceParameters",{...r==null?void 0:r.invoiceParameters,calculationsByOrderType:{...(o=r==null?void 0:r.invoiceParameters)==null?void 0:o.calculationsByOrderType,MISCELLANEOUS:((j=(d=(l=r==null?void 0:r.invoiceParameters)==null?void 0:l.calculationsByOrderType)==null?void 0:d.MISCELLANEOUS)==null?void 0:j.filter((O,v)=>v!==a))??[]}})},n=()=>{var a,o,l;return s("invoiceParameters",{...r==null?void 0:r.invoiceParameters,calculationsByOrderType:{...(a=r==null?void 0:r.invoiceParameters)==null?void 0:a.calculationsByOrderType,MISCELLANEOUS:[...((l=(o=r==null?void 0:r.invoiceParameters)==null?void 0:o.calculationsByOrderType)==null?void 0:l.MISCELLANEOUS)??[],{amount:0,text:"",isVatApplicable:!0}]}})},{calculationsByOrderType:y,validItem:h,isInHouseType:m}=r.invoiceParameters;k.useEffect(()=>{const a=o=>{var j,O,v,L,B,A;const l=(v=(O=(j=r.invoiceParameters)==null?void 0:j.calculationsByOrderType)==null?void 0:O[o])==null?void 0:v.totalOrderValue,d=(A=(B=(L=r.invoiceParameters)==null?void 0:L.calculationsByOrderType)==null?void 0:B[o])==null?void 0:A.commissionRate;return l===void 0||d===void 0?0:l*.01*d};Object.hasOwn(r.invoiceParameters.calculationsByOrderType,"DELIVERY")&&s("invoiceParameters.calculationsByOrderType.DELIVERY.amount",a("DELIVERY")),Object.hasOwn(r.invoiceParameters.calculationsByOrderType,"COLLECTION")&&s("invoiceParameters.calculationsByOrderType.COLLECTION.amount",a("COLLECTION"))},[(D=(E=r.invoiceParameters.calculationsByOrderType)==null?void 0:E.DELIVERY)==null?void 0:D.totalOrderValue,(V=(M=r.invoiceParameters.calculationsByOrderType)==null?void 0:M.COLLECTION)==null?void 0:V.totalOrderValue,(F=(C=r.invoiceParameters.calculationsByOrderType)==null?void 0:C.DELIVERY)==null?void 0:F.commissionRate,(I=(P=r.invoiceParameters.calculationsByOrderType)==null?void 0:P.COLLECTION)==null?void 0:I.commissionRate]);const u=[...Object.entries(y).map(([a,o])=>{var d,j,O,v,L,B,A,U,z,G,Q,q,W,K,J,X,Z,ee,re,ie,ne,se,ae,oe,te,le,ce,de;let l=null;if(a==="COLLECTION")l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(p,{children:[e.jsx(t,{children:`${o.commissionRate}% Commission on Collection Orders value`}),e.jsx(c,{name:"invoiceParameters.calculationsByOrderType.COLLECTION.totalOrderValue",label:"",extraProps:{prefix:"£",maw:"100px"}})]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(v=(O=(j=(d=r==null?void 0:r.invoiceParameters)==null?void 0:d.calculationsByOrderType)==null?void 0:j[a])==null?void 0:O.amount)==null?void 0:v.toFixed(2)})})]});else if(a==="DELIVERY")l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(p,{children:[e.jsx(t,{children:`${o.commissionRate}% Commission on Delivery Orders value`}),e.jsx(c,{name:"invoiceParameters.calculationsByOrderType.DELIVERY.totalOrderValue",label:"",extraProps:{prefix:"£",maw:"100px"}})]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(U=(A=(B=(L=r==null?void 0:r.invoiceParameters)==null?void 0:L.calculationsByOrderType)==null?void 0:B[a])==null?void 0:A.amount)==null?void 0:U.toFixed(2)})})]});else if(a==="SERVICE_FEE"&&!o.isCashOrders)l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(t,{children:["Service Fee Paid (",o.totalOrders," Orders)"]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(q=(Q=(G=(z=r==null?void 0:r.invoiceParameters)==null?void 0:z.calculationsByOrderType)==null?void 0:G[a])==null?void 0:Q.amount)==null?void 0:q.toFixed(2)})})]});else if(a==="SERVICE_FEE"&&o.isCashOrders)l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(t,{children:["Service Fee Paid By Cash Orders (",o.totalOrders," Orders)"]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(X=(J=(K=(W=r==null?void 0:r.invoiceParameters)==null?void 0:W.calculationsByOrderType)==null?void 0:K[a])==null?void 0:J.amount)==null?void 0:X.toFixed(2)})})]});else if(a==="DELIVERY_CHARGE"&&!o.isCashOrders&&!m)l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(t,{children:["Delivery Charge (",o.totalOrders," Orders)"]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(ie=(re=(ee=(Z=r==null?void 0:r.invoiceParameters)==null?void 0:Z.calculationsByOrderType)==null?void 0:ee[a])==null?void 0:re.amount)==null?void 0:ie.toFixed(2)})})]});else if(a==="DELIVERY_CHARGE"&&o.isCashOrders&&!m)l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(t,{children:["Delivery Charge Paid By Cash Orders (",o.totalOrders," Orders)"]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(oe=(ae=(se=(ne=r==null?void 0:r.invoiceParameters)==null?void 0:ne.calculationsByOrderType)==null?void 0:se[a])==null?void 0:ae.amount)==null?void 0:oe.toFixed(2)})})]});else if(a==="DRIVER_TIP"&&!m)l=e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(t,{children:["Driver Tip (",o.totalOrders," Orders)"]})}),e.jsx(i.Td,{children:e.jsx(t,{children:(de=(ce=(le=(te=r==null?void 0:r.invoiceParameters)==null?void 0:te.calculationsByOrderType)==null?void 0:le[a])==null?void 0:ce.amount)==null?void 0:de.toFixed(2)})})]});else if(a==="MISCELLANEOUS")return null;return l}),...(w=(g=r==null?void 0:r.invoiceParameters)==null?void 0:g.calculationsByOrderType)!=null&&w.MISCELLANEOUS&&((S=(b=(f=r==null?void 0:r.invoiceParameters)==null?void 0:f.calculationsByOrderType)==null?void 0:b.MISCELLANEOUS)==null?void 0:S.length)>0?r.invoiceParameters.calculationsByOrderType.MISCELLANEOUS.map((a,o)=>e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(p,{children:[e.jsx(we,{color:"red",variant:"subtle",onClick:l=>x(o),children:e.jsx(He,{})}),e.jsx(De,{name:`invoiceParameters.calculationsByOrderType.MISCELLANEOUS[${o}].text`,label:""}),e.jsx(Me,{name:`invoiceParameters.calculationsByOrderType.MISCELLANEOUS[${o}].isVatApplicable`,label:"VAT Applicable",RenderTextNodeforAlignment:!1})]})}),e.jsx(i.Td,{children:e.jsx(c,{name:`invoiceParameters.calculationsByOrderType.MISCELLANEOUS[${o}].amount`,label:"",extraProps:{prefix:"£",maw:"100px"}})})]},`MISCELLANEOUS ${o}`)):[],...h.length>0?h.map((a,o)=>e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(t,{children:[" ",`${a.itemName}, ${a.totalQuantity} Qty (Remaining £${a.balanceAmount.toFixed(2)})`]})}),e.jsx(i.Td,{children:e.jsx(c,{name:`invoiceParameters.validItem[${o}].deductableAmount`,label:"",extraProps:{prefix:"£",maw:"100px"}})})]},a._id)):[]],T=k.useMemo(()=>e.jsxs(i.Tr,{children:[e.jsx(i.Th,{children:"Description"}),e.jsx(i.Th,{children:"Amount"})]}),[]);return e.jsxs(Ve,{children:[e.jsxs(i,{captionSide:"bottom",withColumnBorders:!0,withRowBorders:!0,withTableBorder:!0,borderColor:"black",mt:20,children:[e.jsx(i.Thead,{children:T}),e.jsx(i.Tbody,{children:u})]}),e.jsx($,{onClick:()=>n(),mt:10,variant:"outline",children:"Add Row in the table"})]})}function Ge(){var h,m,u;const{values:r}=ve(),s=(h=r==null?void 0:r.invoiceParameters)==null?void 0:h.isInHouseType,x=(m=r==null?void 0:r.invoiceParameters)==null?void 0:m.deliveryChargeInHouse,n=(u=r==null?void 0:r.invoiceParameters)==null?void 0:u.driverTipInHouse,y=[e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsx(t,{children:"Total Orders"})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.totalOrdersCount",label:"",extraProps:{maw:"100px"}})})]},"totalOrdersCount"),e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsx(t,{children:"Delivery Orders"})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.deliveryOrderCount",label:"",extraProps:{maw:"100px"}})})]},"deliveryOrderCount"),e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsx(t,{children:"Collection Orders"})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.collectionOrderCount",label:"",extraProps:{maw:"100px"}})})]},"collectionOrderCount"),e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(p,{children:[e.jsx(c,{name:"invoiceParameters.cardPaymentCount",label:"",extraProps:{maw:"100px"}})," ",e.jsx(t,{children:"Card Payments"})]})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.cardPaymentAmount",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"cardPaymentAmount"),e.jsxs(i.Tr,{children:[e.jsxs(i.Td,{children:[e.jsxs(p,{children:[e.jsx(c,{name:"invoiceParameters.cashPaymentCount",label:"",extraProps:{maw:"100px"}})," ",e.jsx(t,{children:"Cash Payments (Including Service & Delivery Charges)"})]})," "]}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.cashPaymentAmount",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"cashPaymentAmount"),...s&&x?[e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(p,{children:[e.jsx(t,{children:"Own delivery charges ("}),e.jsx(c,{name:"invoiceParameters.deliveryChargeInHouse.totalOrders",label:"",extraProps:{maw:"100px"}}),e.jsx(t,{children:") orders"})]})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.deliveryChargeInHouse.amount",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"isInHouseType_deliveryChargeInHouse")]:[],...s&&n?[e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(p,{children:[e.jsx(t,{children:" Driver tip paid ("}),e.jsx(c,{name:"invoiceParameters.driverTipInHouse.totalOrders",label:"",extraProps:{maw:"100px"}}),e.jsx(t,{children:") orders"})]})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.driverTipInHouse.amount",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"isInHouseType_driverTipInHouse")]:[],e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsx(t,{children:"Total Sales"})}),e.jsx(i.Td,{children:e.jsx(c,{name:"invoiceParameters.totalSales",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"totalSales")];return e.jsxs(e.Fragment,{children:[e.jsx(_,{order:4,mt:20,mb:10,m:"auto",children:"Summary Table"}),e.jsx(i,{withColumnBorders:!0,withRowBorders:!0,withTableBorder:!0,borderColor:"black",children:e.jsx(i.Tbody,{children:y})})]})}const Qe=r=>{const{closeModal:s,initialValues:x}=r,n=k.useRef(null),{mutateAsync:y,isPending:h,isSuccess:m}=Ue(),u=T=>{y({updates:T})};return k.useEffect(()=>{m&&s()},[m]),e.jsxs(Ie,{p:"xl",shadow:"sm",withBorder:!0,w:"100%",pos:"relative",children:[e.jsx(Le,{initialValues:x,onSubmit:u,innerRef:n,children:({values:T,setFieldValue:E})=>e.jsx(Be,{children:e.jsxs(Ne,{w:"100%",children:[e.jsxs(_,{order:5,ta:"center",mb:20,c:"grey",children:["Invoice Id: ",T==null?void 0:T.invoiceId]}),e.jsx(ge,{children:e.jsx(N,{name:"invoiceParameters.invoiceDate",label:"Invoice Date"})}),e.jsxs(p,{children:[e.jsx(N,{name:"fromDate",label:"From Date"}),e.jsx(N,{name:"toDate",label:"To Date"})]}),e.jsx(ze,{}),e.jsx(Ge,{}),e.jsx(_,{order:4,mt:20,mb:10,m:"auto",children:"Account Section"}),e.jsxs(p,{children:[e.jsx(c,{name:"invoiceParameters.openingBalance",label:"Opening Balance",extraProps:{prefix:"£"}}),e.jsx(c,{name:"invoiceParameters.closingBalance",label:"Closing Balance",extraProps:{prefix:"£"}}),e.jsx(c,{name:"invoiceParameters.currentInvoiceCount",label:"Current Invoice Count"})]}),e.jsxs(p,{grow:!0,gap:"md",mt:20,children:[e.jsx($,{type:"submit",loading:h,children:"Submit"}),e.jsx($,{type:"reset",variant:"outline",disabled:h,children:"Reset"})]})]})})}),e.jsx(ke,{visible:h,zIndex:1e3,overlayProps:{radius:"sm",blur:2}})]})},qe=({invoiceId:r})=>{const s=Ee.VIEW_INVOICE_BY_MERCHANT();return Oe.POST(s,{invoiceId:r})},We=()=>{const r=ye();return Ce({mutationFn:({invoiceId:s})=>qe({invoiceId:s}),onSuccess:s=>{var x;(x=s==null?void 0:s.data)!=null&&x.success&&r.invalidateQueries({queryKey:["All_Invoices-Grid-data"]})},onError:s=>{Pe(s)}})},Ke=()=>{const{mutateAsync:r,isPending:s,variables:x}=We();return{handleViewAndDownloadInvoice:async({invoiceId:y,downloadlink:h})=>{let m;try{await r({invoiceId:y}),m=window.open(h,"_blank","noopener,noreferrer")}catch(u){if(!m)throw new Error("Failed to open a new window. The browser may have blocked it.");u instanceof Error&&Te.show({title:"Error",message:u.message||"Failed to view or download the invoice.",color:"red"})}},isPending:s,variables:x}},Je=({label:r,value:s})=>e.jsxs(Y,{children:[e.jsx(t,{variant:"body1",sx:{fontWeight:600},children:r}),e.jsx(t,{variant:"body2",color:"textSecondary",children:s})]}),or=({row:r})=>{var P,I,g,w,f,b,S,a,o,l;const s=(P=r.original)==null?void 0:P.downloadLink,x=(I=r.original)==null?void 0:I.isEditable,n=(g=r.original)==null?void 0:g.invoiceParameters,[y,{open:h,close:m}]=xe(!1),{pathname:u}=fe(),{handleViewAndDownloadInvoice:T,isPending:E}=Ke(),[D,{open:M,close:V}]=xe(!1),C=u==null?void 0:u.includes("accounting/invoices"),F=[{label:"Total Sales",value:`£${n==null?void 0:n.totalSales}`},{label:"Total Orders Count",value:n==null?void 0:n.totalOrdersCount},{label:"Delivery Orders",value:n==null?void 0:n.deliveryOrderCount},{label:"Collection Orders",value:n==null?void 0:n.collectionOrderCount},{label:`Card Payments (${n==null?void 0:n.cardPaymentCount})`,value:`£${n==null?void 0:n.cardPaymentAmount}`},{label:`Cash Payments (${n==null?void 0:n.cashPaymentCount})`,value:`£${n==null?void 0:n.cashPaymentAmount}`},{label:"Delivery Order Value",value:`£${n==null?void 0:n.deliveryOrderValue}`},{label:"Collection Order Value",value:`£${n==null?void 0:n.collectionOrderValue}`}];return e.jsxs(e.Fragment,{children:[e.jsx(Y,{sx:{padding:1},children:e.jsxs(Fe,{elevation:2,sx:{padding:2},children:[e.jsxs(Re,{justify:"space-between",align:"flex-start",children:[e.jsxs(t,{variant:"h6",sx:{marginBottom:2,display:"flex",alignItems:"center"},children:[e.jsx(Ye,{sx:{marginRight:1},color:"primary"}),"Invoice Summary"]}),((w=r.original)==null?void 0:w.isSentToMerchant)&&((f=r.original)==null?void 0:f.sentToMerchantAt)&&C&&e.jsxs(p,{mr:20,children:[e.jsxs(t,{variant:"subtitle1",style:{fontStyle:"italic"},children:["Sent to Merchant at"," ",me((b=r.original)==null?void 0:b.sentToMerchantAt).format("DD MMM YYYY hh:mm A")]}),((a=(S=r.original)==null?void 0:S.viewHistory)==null?void 0:a.length)>0&&e.jsxs(H,{position:"top",withArrow:!0,shadow:"md",opened:D,children:[e.jsx(H.Target,{children:e.jsx(R,{onMouseEnter:M,onMouseLeave:V,variant:"outlined",children:"Seen History"})}),e.jsxs(H.Dropdown,{style:{pointerEvents:"none"},children:[e.jsx(t,{children:"Merchant Seen History :"}),e.jsx(ue,{mt:5,children:(l=(o=r.original)==null?void 0:o.viewHistory)==null?void 0:l.map(d=>e.jsx(ue.Item,{children:me(d).format("DD MMM YYYY hh:mm A")},d))})]})]})]})]}),e.jsx(he,{sx:{marginBottom:2}}),e.jsx(Y,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(250px, 1fr))",gap:2,marginBottom:2},children:F.map(d=>e.jsx(Je,{label:d.label,value:d.value},d.label))}),e.jsx(he,{sx:{marginTop:2}}),e.jsxs(p,{mt:20,align:"flex-end",children:[s&&C?e.jsx(R,{variant:"contained",href:s,target:"_blank",rel:"noopener noreferrer",sx:{marginTop:1},startIcon:e.jsx(pe,{}),children:"Download Invoice"}):e.jsx(R,{variant:"contained",color:"primary",onClick:()=>{var d,j;T({invoiceId:(d=r.original)==null?void 0:d.invoiceId,downloadlink:(j=r.original)==null?void 0:j.downloadLink})},startIcon:E?e.jsx(be,{size:"xs",color:"white"}):e.jsx(pe,{}),children:"Download Invoice"}),C&&x&&e.jsx(R,{variant:"outlined",color:"primary",onClick:h,sx:{marginTop:1},startIcon:e.jsx($e,{}),children:"EDIT INVOICE"})]})]})}),e.jsx(Se,{opened:y,onClose:m,title:"",fullScreen:!0,radius:10,closeButtonProps:{iconSize:"lg"},transitionProps:{transition:"fade",duration:200},children:e.jsx(Qe,{initialValues:r.original,closeModal:m})})]})};export{or as I,Ue as a,Ke as u};
