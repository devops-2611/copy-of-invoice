import{z as Q,j as e,l as q,D as K,r as D,P as W,B as J,G as x,k as F,A as X,M as _,ad as Z,S as H,ae as ee}from"./index-BGPQORr6.js";import{F as re,h as se,e as ie}from"./index.esm-DYQ8eCU5.js";import{c as ne,h as M,i as c,e as l,j as ae,g as te,k as le,B as k,P as oe,F as ce,l as R,m as z}from"./MUIThemeProvider-DYjjTKgw.js";import{u as de,L as me,j as V}from"./DateTimePicker-CSAYhhtV.js";import{A as xe,a as ue}from"./ApiConstants-D1IcDG0W.js";import{d as he}from"./helperFuntions-IpEH5JRM.js";import{S as pe,T as s,I as je,L as G}from"./IconTrash-BdsgRmiH.js";import{T as N}from"./Title-DxxQha-n.js";/**
 * @license @tabler/icons-react v3.21.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ye=Q("outline","edit","IconEdit",[["path",{d:"M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1",key:"svg-0"}],["path",{d:"M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z",key:"svg-1"}],["path",{d:"M16 5l3 3",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.21.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ce=Q("outline","file-download","IconFileDownload",[["path",{d:"M14 3v4a1 1 0 0 0 1 1h4",key:"svg-0"}],["path",{d:"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z",key:"svg-1"}],["path",{d:"M12 17v-6",key:"svg-2"}],["path",{d:"M9.5 14.5l2.5 2.5l2.5 -2.5",key:"svg-3"}]]);const ve=ne(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle"),Te=({updates:r})=>{const t=ue.EDIT_MERCHANT_INVOICE();return xe.PUT(t,r)},Oe=()=>{const r=q();return de({mutationFn:({updates:t})=>Te({updates:t}),onSuccess:t=>{var u;K.show({title:"Invoice Update",message:((u=t==null?void 0:t.data)==null?void 0:u.message)??"Invoice updated successfully",color:"green",autoClose:2e3,position:"top-center"}),r.invalidateQueries({queryKey:["All_Invoices-Grid-data"]})},onError:t=>{he(t)}})};function Ee(){var m,E,A,v,P,g,f,w,L,S,b,I,B;const{values:r,setFieldValue:t}=ie(),u=a=>{var n,o,p,j;t("invoiceParameters",{...r==null?void 0:r.invoiceParameters,calculationsByOrderType:{...(n=r==null?void 0:r.invoiceParameters)==null?void 0:n.calculationsByOrderType,MISCELLANEOUS:((j=(p=(o=r==null?void 0:r.invoiceParameters)==null?void 0:o.calculationsByOrderType)==null?void 0:p.MISCELLANEOUS)==null?void 0:j.filter((T,C)=>C!==a))??[]}})},i=()=>{var a,n,o;return t("invoiceParameters",{...r==null?void 0:r.invoiceParameters,calculationsByOrderType:{...(a=r==null?void 0:r.invoiceParameters)==null?void 0:a.calculationsByOrderType,MISCELLANEOUS:[...((o=(n=r==null?void 0:r.invoiceParameters)==null?void 0:n.calculationsByOrderType)==null?void 0:o.MISCELLANEOUS)??[],{amount:0,text:"",isVatApplicable:!0}]}})},{calculationsByOrderType:O,validItem:h}=r.invoiceParameters;D.useEffect(()=>{const a=n=>{var j,T,C,$,Y,U;const o=(C=(T=(j=r.invoiceParameters)==null?void 0:j.calculationsByOrderType)==null?void 0:T[n])==null?void 0:C.totalOrderValue,p=(U=(Y=($=r.invoiceParameters)==null?void 0:$.calculationsByOrderType)==null?void 0:Y[n])==null?void 0:U.commissionRate;return o===void 0||p===void 0?0:o*.01*p};Object.hasOwn(r.invoiceParameters.calculationsByOrderType,"DELIVERY")&&t("invoiceParameters.calculationsByOrderType.DELIVERY.amount",a("DELIVERY")),Object.hasOwn(r.invoiceParameters.calculationsByOrderType,"COLLECTION")&&t("invoiceParameters.calculationsByOrderType.COLLECTION.amount",a("COLLECTION"))},[(E=(m=r.invoiceParameters.calculationsByOrderType)==null?void 0:m.DELIVERY)==null?void 0:E.totalOrderValue,(v=(A=r.invoiceParameters.calculationsByOrderType)==null?void 0:A.COLLECTION)==null?void 0:v.totalOrderValue,(g=(P=r.invoiceParameters.calculationsByOrderType)==null?void 0:P.DELIVERY)==null?void 0:g.commissionRate,(w=(f=r.invoiceParameters.calculationsByOrderType)==null?void 0:f.COLLECTION)==null?void 0:w.commissionRate]);const y=[...Object.entries(O).map(([a,n])=>{var p,j,T,C;let o=e.jsx(e.Fragment,{});if(a==="COLLECTION")o=e.jsxs(x,{children:[e.jsx(l,{children:`${n.commissionRate}% Commission on Collection Orders value`}),e.jsx(c,{name:"invoiceParameters.calculationsByOrderType.COLLECTION.totalOrderValue",label:"",extraProps:{prefix:"£",maw:"100px"}})]});else if(a==="DELIVERY")o=e.jsxs(x,{children:[e.jsx(l,{children:`${n.commissionRate}% Commission on Delivery Orders value`})," ",e.jsx(c,{name:"invoiceParameters.calculationsByOrderType.DELIVERY.totalOrderValue",label:"",extraProps:{prefix:"£",maw:"100px"}})]});else if(a==="SERVICE_FEE"&&!n.isCashOrders)o=e.jsxs(l,{children:["Service Fee Paid (",n.totalOrders," Orders)"]});else if(a==="SERVICE_FEE"&&n.isCashOrders)o=e.jsxs(l,{children:["Service Fee Paid By Cash Orders (",n.totalOrders," Orders)"]});else if(a==="DELIVERY_CHARGE"&&!n.isCashOrders)o=e.jsxs(l,{children:["Delivery Charge (",n.totalOrders," Orders)"]});else if(a==="DELIVERY_CHARGE"&&n.isCashOrders)o=e.jsxs(l,{children:["Delivery Charge Paid By Cash Orders (",n.totalOrders," Orders)"]});else if(a==="DRIVER_TIP")o=e.jsxs(l,{children:["Driver Tip (",n.totalOrders," Orders)"]});else if(a==="MISCELLANEOUS")return null;return e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:o}),e.jsx(s.Td,{children:["DELIVERY","COLLECTION"].includes(a)?e.jsx(l,{children:(C=(T=(j=(p=r==null?void 0:r.invoiceParameters)==null?void 0:p.calculationsByOrderType)==null?void 0:j[a])==null?void 0:T.amount)==null?void 0:C.toFixed(2)}):e.jsx(c,{name:`invoiceParameters.calculationsByOrderType.${a}.amount`,label:"",extraProps:{prefix:"£",maw:"100px"}})})]},a)}),...(S=(L=r==null?void 0:r.invoiceParameters)==null?void 0:L.calculationsByOrderType)!=null&&S.MISCELLANEOUS&&((B=(I=(b=r==null?void 0:r.invoiceParameters)==null?void 0:b.calculationsByOrderType)==null?void 0:I.MISCELLANEOUS)==null?void 0:B.length)>0?r.invoiceParameters.calculationsByOrderType.MISCELLANEOUS.map((a,n)=>e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsxs(x,{children:[e.jsx(X,{color:"red",variant:"subtle",onClick:o=>u(n),children:e.jsx(je,{})}),e.jsx(ae,{name:`invoiceParameters.calculationsByOrderType.MISCELLANEOUS[${n}].text`,label:""}),e.jsx(te,{name:`invoiceParameters.calculationsByOrderType.MISCELLANEOUS[${n}].isVatApplicable`,label:"VAT Applicable",RenderTextNodeforAlignment:!1})]})}),e.jsx(s.Td,{children:e.jsx(c,{name:`invoiceParameters.calculationsByOrderType.MISCELLANEOUS[${n}].amount`,label:"",extraProps:{prefix:"£",maw:"100px"}})})]},`MISCELLANEOUS ${n}`)):[],...h.length>0?h.map(a=>e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsxs(l,{children:[" ",`${a.itemName}, ${a.totalQuantity} Qty (Remaining £${a.balanceAmount.toFixed(2)})`]})}),e.jsx(s.Td,{children:e.jsx(c,{name:`invoiceParameters.validItem[${a._id}].deductableAmount`,label:"",extraProps:{prefix:"£",maw:"100px"}})})]},a._id)):[]],d=D.useMemo(()=>e.jsxs(s.Tr,{children:[e.jsx(s.Th,{children:"Description"}),e.jsx(s.Th,{children:"Amount"})]}),[]);return e.jsxs(le,{children:[e.jsxs(s,{captionSide:"bottom",withColumnBorders:!0,withRowBorders:!0,withTableBorder:!0,borderColor:"black",mt:20,children:[e.jsx(s.Thead,{children:d}),e.jsx(s.Tbody,{children:y})]}),e.jsx(F,{onClick:()=>i(),mt:10,variant:"outline",children:"Add Row in the table"})]})}function Pe(){const r=[e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsx(l,{children:"Total Orders"})}),e.jsx(s.Td,{children:e.jsx(c,{name:"invoiceParameters.totalOrdersCount",label:"",extraProps:{maw:"100px"}})})]},"totalOrdersCount"),e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsx(l,{children:"Delivery Orders"})}),e.jsx(s.Td,{children:e.jsx(c,{name:"invoiceParameters.deliveryOrderCount",label:"",extraProps:{maw:"100px"}})})]},"deliveryOrderCount"),e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsx(l,{children:"Collection Orders"})}),e.jsx(s.Td,{children:e.jsx(c,{name:"invoiceParameters.collectionOrderCount",label:"",extraProps:{maw:"100px"}})})]},"collectionOrderCount"),e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsxs(x,{children:[e.jsx(c,{name:"invoiceParameters.cardPaymentCount",label:"",extraProps:{maw:"100px"}})," ",e.jsx(l,{children:"Card Payments"})]})}),e.jsx(s.Td,{children:e.jsx(c,{name:"invoiceParameters.cardPaymentAmount",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"cardPaymentAmount"),e.jsxs(s.Tr,{children:[e.jsxs(s.Td,{children:[e.jsxs(x,{children:[e.jsx(c,{name:"invoiceParameters.cashPaymentCount",label:"",extraProps:{maw:"100px"}})," ",e.jsx(l,{children:"Cash Payments (Including Service & Delivery Charges)"})]})," "]}),e.jsx(s.Td,{children:e.jsx(c,{name:"invoiceParameters.cashPaymentAmount",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"cashPaymentAmount"),e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsx(l,{children:"Total Sales"})}),e.jsx(s.Td,{children:e.jsx(c,{name:"invoiceParameters.totalSales",label:"",extraProps:{prefix:"£",maw:"100px"}})})]},"totalSales")];return e.jsxs(e.Fragment,{children:[e.jsx(N,{order:4,mt:20,mb:10,m:"auto",children:"Summary Table"}),e.jsx(s,{withColumnBorders:!0,withRowBorders:!0,withTableBorder:!0,borderColor:"black",children:e.jsx(s.Tbody,{children:r})})]})}const ge=r=>{const{closeModal:t,initialValues:u}=r,i=D.useRef(null),{mutateAsync:O,isPending:h,isSuccess:y}=Oe(),d=m=>{O({updates:m})};return D.useEffect(()=>{y&&t()},[y]),e.jsxs(W,{p:"xl",shadow:"sm",withBorder:!0,w:"100%",pos:"relative",children:[e.jsx(re,{initialValues:u,onSubmit:d,innerRef:i,children:({values:m,setFieldValue:E})=>e.jsx(se,{children:e.jsxs(pe,{w:"100%",children:[e.jsxs(N,{order:5,ta:"center",mb:20,c:"grey",children:["Invoice Id: ",m==null?void 0:m.invoiceId]}),e.jsx(J,{children:e.jsx(M,{name:"invoiceParameters.invoiceDate",label:"Invoice Date"})}),e.jsxs(x,{children:[e.jsx(M,{name:"fromDate",label:"From Date"}),e.jsx(M,{name:"toDate",label:"To Date"})]}),e.jsx(Ee,{}),e.jsx(Pe,{}),e.jsx(N,{order:4,mt:20,mb:10,m:"auto",children:"Account Section"}),e.jsxs(x,{children:[e.jsx(c,{name:"invoiceParameters.openingBalance",label:"Opening Balance",extraProps:{prefix:"£"}}),e.jsx(c,{name:"invoiceParameters.closingBalance",label:"Closing Balance",extraProps:{prefix:"£"}}),e.jsx(c,{name:"invoiceParameters.currentInvoiceCount",label:"Current Invoice Count"})]}),e.jsxs(x,{grow:!0,gap:"md",mt:20,children:[e.jsx(F,{type:"submit",loading:h,children:"Submit"}),e.jsx(F,{type:"reset",variant:"outline",disabled:h,children:"Reset"})]})]})})}),e.jsx(me,{visible:h,zIndex:1e3,overlayProps:{radius:"sm",blur:2}})]})},fe=({label:r,value:t})=>e.jsxs(k,{children:[e.jsx(l,{variant:"body1",sx:{fontWeight:600},children:r}),e.jsx(l,{variant:"body2",color:"textSecondary",children:t})]}),Me=r=>{var P,g,f,w,L,S,b,I,B,a;const t=(P=r.row.original)==null?void 0:P.downloadLink,u=(g=r.row.original)==null?void 0:g.isEditable,i=(f=r.row.original)==null?void 0:f.invoiceParameters,[O,{open:h,close:y}]=_(!1),{pathname:d}=Z(),[m,{open:E,close:A}]=_(!1),v=[{label:"Total Sales",value:`£${i==null?void 0:i.totalSales}`},{label:"Total Orders Count",value:i==null?void 0:i.totalOrdersCount},{label:"Delivery Orders",value:i==null?void 0:i.deliveryOrderCount},{label:"Collection Orders",value:i==null?void 0:i.collectionOrderCount},{label:`Card Payments (${i==null?void 0:i.cardPaymentCount}) `,value:`£${i==null?void 0:i.cardPaymentAmount}`},{label:`Cash Payments (${i==null?void 0:i.cashPaymentCount})`,value:`£${i==null?void 0:i.cashPaymentAmount}`},{label:"Delivery Order Value",value:`£${i==null?void 0:i.deliveryOrderValue}`},{label:"Collection Order Value",value:`£${i==null?void 0:i.collectionOrderValue}`}];return e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{padding:1},children:e.jsxs(oe,{elevation:2,sx:{padding:2},children:[e.jsxs(ce,{justify:"space-between",align:"flex-start",children:[e.jsxs(l,{variant:"h6",sx:{marginBottom:2,display:"flex",alignItems:"center"},children:[e.jsx(ve,{sx:{marginRight:1},color:"primary"}),"Invoice Summary"]}),((w=r.row.original)==null?void 0:w.isSentToMerchant)&&((L=r.row.original)==null?void 0:L.sentToMerchantAt)&&(d==null?void 0:d.includes("accounting/invoices"))&&e.jsxs(x,{mr:20,children:[e.jsxs(l,{variant:"subtitle1",style:{fontStyle:"italic"},children:["Sent to Merchant at"," ",H((S=r.row.original)==null?void 0:S.sentToMerchantAt).format("DD MMM YYYY hh:mm A")]}),((I=(b=r.row.original)==null?void 0:b.viewHistory)==null?void 0:I.length)>0&&e.jsxs(V,{position:"top",withArrow:!0,shadow:"md",opened:m,children:[e.jsx(V.Target,{children:e.jsx(R,{onMouseEnter:E,onMouseLeave:A,variant:"outlined",children:"Seen History"})}),e.jsxs(V.Dropdown,{style:{pointerEvents:"none"},children:[e.jsx(l,{children:"Merchant Seen History :"}),e.jsx(G,{mt:5,children:(a=(B=r.row.original)==null?void 0:B.viewHistory)==null?void 0:a.map(n=>e.jsx(G.Item,{children:H(n).format("DD MMM YYYY hh:mm A")},n))})]})]})]})]}),e.jsx(z,{sx:{marginBottom:2}}),e.jsx(k,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(250px, 1fr))",gap:2,marginBottom:2},children:v==null?void 0:v.map(n=>e.jsx(fe,{label:n.label,value:n.value},n.label))}),e.jsx(z,{sx:{marginTop:2}}),e.jsxs(x,{mt:20,align:"flex-end",children:[t&&e.jsx(R,{variant:"contained",color:"primary",href:t,target:"_blank",rel:"noopener noreferrer",sx:{marginTop:1},startIcon:e.jsx(Ce,{}),children:"Download Invoice"}),(d==null?void 0:d.includes("accounting/invoices"))&&u&&e.jsx(R,{variant:"outlined",color:"primary",onClick:()=>h(),sx:{marginTop:1},startIcon:e.jsx(ye,{}),children:"EDIT INVOICE"})]})]})}),e.jsx(ee,{opened:O,onClose:y,title:"",fullScreen:!0,radius:10,closeButtonProps:{iconSize:"lg"},transitionProps:{transition:"fade",duration:200},children:e.jsx(ge,{initialValues:r.row.original,closeModal:y})})]})};export{Me as I,Oe as u};
